<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BLEåŠ é€Ÿåº¦ãƒ‡ãƒ¼ã‚¿å—ä¿¡</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* --- Design System -------------------------------------------------- */
    :root {
      --bg: #0b0c10;
      --panel: #12141a;
      --card: #161922;
      --text: #e9eef5;
      --muted: #9aa7b5;
      --primary: #3b82f6;
      --danger: #ef4444;
      --success: #22c55e;
      --warning: #f59e0b;
      --ring: rgba(59,130,246,.45);
      --shadow: 0 6px 24px rgba(0,0,0,.35), 0 1px 0 rgba(255,255,255,.05) inset;
      --radius: 16px;
      --radius-sm: 12px;
    }

    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f4f6fb;
        --panel: #ffffff;
        --card: #ffffff;
        --text: #111827;
        --muted: #6b7280;
        --shadow: 0 6px 24px rgba(2,6,23,.06), 0 1px 0 rgba(2,6,23,.04) inset;
      }
    }

    /* Base */
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 600px at 10% -10%, rgba(59,130,246,.08), transparent 60%),
                  radial-gradient(1200px 600px at 90% -10%, rgba(34,197,94,.08), transparent 60%),
                  var(--bg);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px clamp(16px, 3vw, 32px);
    }

    /* Header */
    .app-header {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 16px;
      background: var(--panel);
      border-radius: var(--radius);
      padding: 16px 20px;
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(8px);
    }
    .title {
      font-size: clamp(18px, 2.4vw, 24px);
      font-weight: 700;
      letter-spacing: .02em;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .badge {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 10px; border-radius: 999px; font-size: 12px; font-weight: 600;
      color: #fff; background: linear-gradient(90deg, var(--primary), #22c55e);
    }

    /* Controls */
    .controls {
      margin-top: 18px;
      display: grid;
      grid-template-columns: 1.2fr 2fr auto;
      gap: 16px;
    }

    .action-card {
      background: var(--panel);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
      display: grid; gap: 12px;
      align-content: center;
    }

    .button-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    .main-btn {
      font-size: clamp(16px, 2.1vw, 20px);
      padding: 14px 18px;
      border-radius: 12px; border: none;
      font-weight: 700; letter-spacing: .02em;
      cursor: pointer;
      color: #fff;
      box-shadow: 0 6px 18px rgba(0,0,0,.25);
      transition: transform .08s ease, filter .18s ease, box-shadow .18s ease, opacity .18s ease;
    }
    .main-btn:active { transform: translateY(1px); }
    .start-btn { background: linear-gradient(180deg, #22c55e, #16a34a); }
    .stop-btn  { background: linear-gradient(180deg, #ef4444, #b91c1c); }
    .send-btn  { background: linear-gradient(180deg, #3b82f6, #1d4ed8); }
    .main-btn:disabled { opacity: .55; filter: grayscale(.2); cursor: not-allowed; }

    .status-card {
      background: var(--panel);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
      display: grid; gap: 8px;
      align-content: center;
    }
    .status-grid { display: grid; grid-template-columns: .9fr 1.1fr; gap: 8px 12px; align-items: center; }
    .status-label { color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: .08em; }
    .status-value { font-weight: 700; }

    .panel {
      background: var(--panel);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
    }

    .setting-panel { display: grid; gap: 14px; }
    .setting-grid {
      display: grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 12px;
      align-items: end;
    }
    .field { display: grid; gap: 6px; }
    .field label { font-size: 12px; color: var(--muted); letter-spacing: .03em; }
    .field input, .field select {
      appearance: none;
      background: var(--card);
      border: 1px solid rgba(148,163,184,.22);
      border-radius: 10px; color: var(--text);
      padding: 10px 1px; font-size: 14px;
      box-shadow: 0 0 0 0 var(--ring);
      transition: box-shadow .15s ease, border-color .15s ease, background .15s ease;
      width: 100%;
      text-align: center
    }
    .field input[type=number] {
      text-align: right;
    }
    .field input:focus, .field select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 6px var(--ring);
    }

    .threshold-row { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; }

    .send-row { display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: end; }

    /* Chart + Output */
    .content {
      margin-top: 18px;
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
    }
    .card { background: var(--panel); border-radius: var(--radius); box-shadow: var(--shadow); }
    .card-header { padding: 14px 16px; border-bottom: 1px solid rgba(148,163,184,.18); display:flex; align-items:center; justify-content:space-between; }
    .card-title { font-weight: 700; }
    .card-body { padding: 12px 16px 16px; }

    #chart { width: 100%; height: 360px; display:block; }
    #output {
      height: 360px; overflow: auto; background: var(--card);
      border-radius: 0 0 var(--radius) var(--radius);
      margin: 0; padding: 12px 14px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 13px;
      border: 1px solid rgba(148,163,184,.18); border-top: none;
      white-space: pre-wrap; 
    }

    /* Tablet/Desktop scaling */
    @media (min-width: 640px) { body { font-size: 16px; } }
    @media (min-width: 768px) { body { font-size: 17.5px; } }
    @media (min-width: 1024px) { body { font-size: 18.5px; } }

    /* Mobile layout */
    @media (max-width: 900px) {
      .controls { grid-template-columns: 1fr; }
      .content  { grid-template-columns: 1fr; }
      .setting-grid { grid-template-columns: repeat(2, minmax(0,1fr)); }
    }

    /* ---- è¨ˆæ¸¬ä¸­UIå¼·èª¿ ---- */
    .badge.active {
      background: linear-gradient(90deg, #ef4444, #b91c1c);
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: .75; }
    }

    /* è¨ˆæ¸¬ä¸­ã¯èƒŒæ™¯ã«èµ¤ã¿ã‚’ä¹—ã›ã‚‹ï¼ˆbodyã«measuring-modeã‚’ä»˜ã‘å¤–ã—ï¼‰ */
    body.measuring-mode {
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(239,68,68,.10), transparent 60%),
        radial-gradient(1200px 600px at 90% -10%, rgba(239,68,68,.10), transparent 60%),
        var(--bg);
    }

    /* ã‚¿ã‚¤ãƒãƒ¼ã‚’å¼·èª¿ï¼ˆã‚¯ãƒ©ã‚¹ä»˜ã‘å¤–ã—ï¼‰ */
    #timer.measuring {
      font-size: 24px;
      color: var(--danger);
      font-weight: 800;
      letter-spacing: .02em;
    }

  </style>
</head>
<body>
  <div class="container">
    <header class="app-header">
      <div class="title">BLEåŠ é€Ÿåº¦ãƒ‡ãƒ¼ã‚¿å—ä¿¡ <span class="badge">Live</span></div>
      <div class="status-grid">
        <div class="status-label">çŠ¶æ…‹</div><div id="now" class="status-value">æœªæ¥ç¶š</div>
        <div class="status-label">ã‚¿ã‚¤ãƒãƒ¼</div><div id="timer" class="status-value">åœæ­¢ä¸­</div>
      </div>
    </header>

    <!-- Controls Row -->
    <section class="controls">
      <div class="action-card">
        <div class="button-row">
          <button id="start" class="main-btn start-btn">â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
          <button id="stop" class="main-btn stop-btn">â–  ã‚¹ãƒˆãƒƒãƒ—</button>
          <button id="connect" class="main-btn" style="margin-bottom:8px; background: linear-gradient(180deg, #2563eb, #1e40af);">ğŸ”— æ¥ç¶š</button>
          <button id="reset" class="main-btn" style="margin-bottom:8px; background: linear-gradient(180deg, #f59e0b, #b45309);">âŸ² ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
      </div>

      <div class="panel">
        <div class="setting-panel">
          <div class="setting-grid">
            <div class="field">
              <label for="axis">è»¸</label>
              <select id="axis">
                <option value="all">ã™ã¹ã¦</option>
                <option value="x">X</option>
                <option value="y">Y</option>
                <option value="z">Z</option>
              </select>
            </div>
            <div class="field">
              <label for="threshold">ã—ãã„å€¤</label>
              <div class="threshold-row">
                <input type="number" step="0.01" id="threshold" value="1.00" />
              </div>
            </div>
            <div class="field">
              <label for="count">å›æ•°</label>
              <input type="number" id="count" value="10" min="1" />
            </div>
            <div class="field">
              <label>æˆå‹æ©ŸåŠ å·¥ã‚µã‚¤ã‚¯ãƒ« (ç§’):
                <input type="number" id="machine_duration" value="10" min="1" max="120" step="1">
              </label>
            </div>
            <div class="field">
              <label>ãƒ­ãƒœãƒƒãƒˆã‚¢ãƒ¼ãƒ å‹•ä½œæ™‚é–“ (ç§’):
                <input type="number" id="duration" value="1" min="1" max="120" step="1">
              </label>
            </div>
            <div class="field">
              <label>&nbsp;</label>
              <button id="sendSetting" class="main-btn send-btn">è¨­å®šé€ä¿¡</button>
            </div>
          </div>
        </div>
      </div>

      <div class="status-card">
        <div class="status-grid">
          <div class="status-label">å—ä¿¡ä»¶æ•°</div><div id="rxCount" class="status-value">0</div>
          <div class="status-label">ã—ãã„å€¤</div><div id="thLabel" class="status-value">1.00</div>
        </div>
      </div>
    </section>

    <!-- Content Row -->
    <section class="content">
      <article class="card">
        <div class="card-header">
          <div class="card-title">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ³¢å½¢</div>
        </div>
        <div class="card-body">
          <canvas id="chart"></canvas>
        </div>
      </article>

      <aside class="card" style="overflow:hidden;">
        <div class="card-header">
          <div class="card-title">ãƒ­ã‚°</div>
        </div>
        <pre id="output" class="card-body"></pre>
      </aside>
    </section>
  </div>

  <script>
    // ------------------ æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæœ€å°å¤‰æ›´ï¼‰ ------------------
    let bleDevice, rxChar, txChar;
    let dataLog = [];

    // ACKé€ä¿¡ç”¨ã®ã‚­ãƒ¥ãƒ¼
    let ackQueue = [];
    let isSendingAck = false;

    let chartInitialized = false;
    let chart;

    const $ = (id) => document.getElementById(id);

    window.onload = () => {
      if (!('bluetooth' in navigator)) {
        display('[ã‚¨ãƒ©ãƒ¼] ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯Web Bluetoothã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ï¼ˆChromeç³» + HTTPS/localhost æ¨å¥¨ï¼‰');
      }
      $('connect').disabled    = false;
      $('reset').disabled      = true;
      $('start').disabled      = true;
      $('stop').disabled       = true;
      $("now").textContent = "æœªæ¥ç¶š";
    };

    function isConnected() {
      return !!(bleDevice?.gatt?.connected && rxChar && txChar);
    }

    // è¨ˆæ¸¬ä¸­UIã®åˆ‡ã‚Šæ›¿ãˆ
    function setMeasuring(on) {
      // ãƒãƒƒã‚¸ã®å¼·èª¿
      const badge = document.querySelector('.badge');
      if (badge) {
        badge.textContent = on ? 'è¨ˆæ¸¬ä¸­' : 'Live';
        badge.classList.toggle('active', on);
      }

      // ç”»é¢å…¨ä½“ã®èƒŒæ™¯ãƒˆãƒ¼ãƒ³
      document.body.classList.toggle('measuring-mode', on);

      // ã‚¿ã‚¤ãƒãƒ¼ã®å¼·èª¿
      $('timer')?.classList.toggle('measuring', on);

      // ç”»é¢ã‚¿ã‚¤ãƒˆãƒ«ã«ã‚‚çŠ¶æ…‹ã‚’åæ˜ ï¼ˆä»»æ„ï¼šå…ˆé ­ã«â—ã‚’ä»˜ã‘ã‚‹ï¼‰
      document.title = (on ? 'â— ' : '') + 'BLEåŠ é€Ÿåº¦ãƒ‡ãƒ¼ã‚¿å—ä¿¡ï¼ˆæ”¹å–„ç‰ˆï¼‰';

      // ãƒœã‚¿ãƒ³çŠ¶æ…‹ï¼ˆé‹ç”¨ãƒãƒªã‚·ãƒ¼ã«åˆã‚ã›èª¿æ•´å¯èƒ½ï¼‰
      // è¨ˆæ¸¬ä¸­ã¯ reset ç„¡åŠ¹ã«ã—ã¦èª¤æ“ä½œã‚’é˜²ã
      if ($('reset')) $('reset').disabled = !!on;
    }

    function initChart() {
      if (chart) chart.destroy();

      const canvas = $('chart');
      const ctx = canvas.getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            {
              label: 'X',
              data: [],
              borderColor: '#ef9ca3',
              borderWidth: 2,
              pointRadius: 0,
              fill: false,
              segment: {
                borderColor: c => {
                  const y1 = c.p0.parsed.y; const y2 = c.p1.parsed.y;
                  const isOver = thresholdY >= 0 ? (y1 > thresholdY || y2 > thresholdY) : (y1 < thresholdY || y2 < thresholdY);
                  return isOver ? '#ef4444' : '#ef9ca3';
                }
              }
            },
            {
              label: 'Y',
              data: [],
              borderColor: '#86efac',
              borderWidth: 2,
              pointRadius: 0,
              fill: false,
              segment: {
                borderColor: c => {
                  const y1 = c.p0.parsed.y; const y2 = c.p1.parsed.y;
                  const isOver = thresholdY >= 0 ? (y1 > thresholdY || y2 > thresholdY) : (y1 < thresholdY || y2 < thresholdY);
                  return isOver ? '#22c55e' : '#86efac';
                }
              }
            },
            {
              label: 'Z',
              data: [],
              borderColor: '#93c5fd',
              borderWidth: 2,
              pointRadius: 0,
              fill: false,
              segment: {
                borderColor: c => {
                  const y1 = c.p0.parsed.y; const y2 = c.p1.parsed.y;
                  const isOver = thresholdY >= 0 ? (y1 > thresholdY || y2 > thresholdY) : (y1 < thresholdY || y2 < thresholdY);
                  return isOver ? '#3b82f6' : '#93c5fd';
                }
              }
            }
          ]
        },
        options: {
          animation: false,
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { suggestedMin: -2, suggestedMax: 2, grid: { color: 'rgba(148,163,184,.2)' } },
            x: { ticks: { display: false }, grid: { color: 'rgba(148,163,184,.12)' } }
          },
          plugins: { customThreshold: {} }
        }
      });

      chartInitialized = true;
    }

    let thresholdY = 1.25;
    let isDragging = false;

    const thresholdPlugin = {
      id: 'customThreshold',
      afterDraw(chart) {
        const yScale = chart.scales.y;
        if (!yScale) return;
        const y = yScale.getPixelForValue(thresholdY);
        const ctx = chart.ctx;
        const {left, right} = chart.chartArea;
        ctx.save();
        ctx.beginPath();
        ctx.moveTo(left, y);
        ctx.lineTo(right, y);
        ctx.strokeStyle = 'rgba(239,68,68,.9)';
        ctx.lineWidth = 2.5;
        ctx.setLineDash([6,6]);
        ctx.stroke();
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text');
        ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
        ctx.fillText(`ã—ãã„å€¤: ${thresholdY.toFixed(2)}`, left + 8, y - 8);
        ctx.restore();
      }
    };
    Chart.register(thresholdPlugin);

    const canvasEl = $('chart');
    canvasEl.addEventListener('mousedown', e => {
      if (!chart) return;
      const rect = canvasEl.getBoundingClientRect();
      const y = e.clientY - rect.top;
      const threshY = chart.scales.y.getPixelForValue(thresholdY);
      if (Math.abs(y - threshY) < 8) isDragging = true;
    });
    canvasEl.addEventListener('mousemove', e => {
      if (isDragging && chart) {
        const rect = canvasEl.getBoundingClientRect();
        const y = e.clientY - rect.top;
        thresholdY = chart.scales.y.getValueForPixel(y);
        $('threshold').value = thresholdY.toFixed(2);
        $('thLabel').textContent = thresholdY.toFixed(2);
        chart.update('none');
        updateAutoCount();
      }
    });
    canvasEl.addEventListener('mouseup', () => isDragging = false);
    canvasEl.addEventListener('mouseleave', () => isDragging = false);
    
    let startTime = null;
    let timerInterval = null;

    function startTimerInterval() {
      stopTimerInterval();
      timerInterval = setInterval(() => {
        if (startTime) {
          const now = Date.now();
          const elapsed = Math.floor((now - startTime) / 1000);
          $('timer').textContent = `è¨ˆæ¸¬ä¸­: ${elapsed}ç§’`;
        }
      }, 200);
    }
    function stopTimerInterval() {
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = null;
    }

    function display(line) {
      const el = $('output');
      el.insertAdjacentText('beforeend', line + '\n'); // å¸¸ã«ãƒ†ã‚­ã‚¹ãƒˆã§è¿½è¨˜
      el.scrollTop = el.scrollHeight;
    }

    // æ¥ç¶šãƒœã‚¿ãƒ³
    $('connect').onclick = async () => {
      try {
        await connect();
        $('now').textContent   = 'æ¥ç¶šæ¸ˆã¿';
        $('connect').disabled    = true;
        $('reset').disabled      = false;
        $('start').disabled      = false;
        // stopã¯è¨ˆæ¸¬é–‹å§‹å¾Œã«ã®ã¿æœ‰åŠ¹åŒ–ã™ã‚‹
      } catch (e) {
        display('[ã‚¨ãƒ©ãƒ¼] æ¥ç¶šå¤±æ•—: ' + (e?.message || e));
      }
    };

    $('start').onclick = async () => {
      try {
        if (!isConnected()) {
          display('[ã‚¨ãƒ©ãƒ¼] å…ˆã«æ¥ç¶šã—ã¦ãã ã•ã„ï¼ˆæ¥ç¶šãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼‰');
          return;
        }
        await sendCommand('START');
        dataLog = [];
        resetChartData();
        display('[é–‹å§‹ã‚³ãƒãƒ³ãƒ‰é€ä¿¡]');
        startTime = Date.now();
        $('timer').textContent = 'è¨ˆæ¸¬ä¸­: 0ç§’';
        $('now').textContent   = 'è¨ˆæ¸¬ä¸­';
        startTimerInterval();
        setMeasuring(true);
        $('start').disabled = true;
        $('stop').disabled  = true; // â† ã“ã“ã¯è¨ˆæ¸¬ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã«åˆã‚ã›ã¦ true/false ã‚’é¸æŠ
        // â€» STOP ã‚’è¨±å¯ã™ã‚‹ãªã‚‰ false ã«
        $('stop').disabled  = false;
      } catch (err) {
        display('[ã‚¨ãƒ©ãƒ¼] ' + err.message);
      }
    };

    $('stop').onclick = async () => {
      await sendCommand('STOP');
      display('[åœæ­¢ã‚³ãƒãƒ³ãƒ‰é€ä¿¡]');
      $('now').textContent = 'åœæ­¢ä¸­';
      stopTimerInterval();
      setMeasuring(false);
      $('stop').disabled = true;
    };

    async function connect() {
      bleDevice = await navigator.bluetooth.requestDevice({
        filters: [{ namePrefix: 'XIAO' }],
        optionalServices: ['6e400001-b5a3-f393-e0a9-e50e24dcca9e']
      });

      bleDevice.addEventListener('gattserverdisconnected', onDisconnected);

      const server = await bleDevice.gatt.connect();
      const service = await server.getPrimaryService('6e400001-b5a3-f393-e0a9-e50e24dcca9e');
      rxChar = await service.getCharacteristic('6e400003-b5a3-f393-e0a9-e50e24dcca9e');
      txChar = await service.getCharacteristic('6e400002-b5a3-f393-e0a9-e50e24dcca9e');
      await rxChar.startNotifications();
      rxChar.addEventListener('characteristicvaluechanged', handleReceive);
      $('now').textContent = 'æ¥ç¶šæ¸ˆã¿';
      if (!chartInitialized) initChart();
    }

    // ACKã‚’ã‚­ãƒ¥ãƒ¼ã«å…¥ã‚Œã¦é€ä¿¡
    async function queueAck() {
      ackQueue.push('ACK');
      processAckQueue();
    }
    async function processAckQueue() {
      if (isSendingAck || ackQueue.length === 0) return;
      isSendingAck = true;
      const encoder = new TextEncoder();
      while (ackQueue.length > 0) {
        try {
          await txChar.writeValue(encoder.encode(ackQueue.shift() + "\n"));
          await new Promise(res => setTimeout(res, 20));
        } catch (err) {
          console.error('ACKé€ä¿¡ã‚¨ãƒ©ãƒ¼:', err);
        }
      }
      isSendingAck = false;
    }

    async function sendCommand(text) {
      const encoder = new TextEncoder();
      await txChar.writeValue(encoder.encode(text + "\n"));
    }

    async function handleReceive(event) {
      const data = event.target.value;
      const byteLength = data.byteLength;

      if (byteLength === 6) {
        const dv = new DataView(data.buffer);
        const ax = dv.getInt16(0, false) / 100.0;
        const ay = dv.getInt16(2, false) / 100.0;
        const az = dv.getInt16(4, false) / 100.0;

        dataLog.push({ ax, ay, az });
        $('rxCount').textContent = dataLog.length;

        if (!chartInitialized) initChart();
        chart.data.labels.push(dataLog.length);
        chart.data.datasets[0].data.push(ax);
        chart.data.datasets[1].data.push(ay);
        chart.data.datasets[2].data.push(az);
        chart.update('none');

        updateAutoCount();
        queueAck();
        return;
      }

      const value = new TextDecoder().decode(event.target.value).trim();
      if (value === 'STARTED') {
        display('[XIAO] è¨ˆæ¸¬é–‹å§‹');
      } else if (value === 'STOPPED') {
        display('[XIAO] è¨ˆæ¸¬åœæ­¢');
      } else if (value === 'ENDED') {
        display('ãƒ‡ãƒ¼ã‚¿å—ä¿¡å®Œäº†ï¼');
        setMeasuring(false);
        $('reset').disabled = false;
        if (dataLog.length === 0) {
          display('[è­¦å‘Š] å—ä¿¡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
          return;
        }

        // å„è»¸ã®æœ€å¤§ãƒ»æœ€å°ã¨è¡Œç•ªå·
        let maxX = -Infinity, minX = Infinity, maxXRow = -1, minXRow = -1;
        let maxY = -Infinity, minY = Infinity, maxYRow = -1, minYRow = -1;
        let maxZ = -Infinity, minZ = Infinity, maxZRow = -1, minZRow = -1;

        dataLog.forEach((row, idx) => {
          if (row.ax > maxX) { maxX = row.ax; maxXRow = idx; }
          if (row.ax < minX) { minX = row.ax; minXRow = idx; }
          if (row.ay > maxY) { maxY = row.ay; maxYRow = idx; }
          if (row.ay < minY) { minY = row.ay; minYRow = idx; }
          if (row.az > maxZ) { maxZ = row.az; maxZRow = idx; }
          if (row.az < minZ) { minZ = row.az; minZRow = idx; }
        });

        // è¡¨ç¤ºç”¨HTMLç”Ÿæˆ
        let html = '';
        dataLog.forEach((row, idx) => {
          const format = (val, isMax, isMin) => {
            if (isMax) return `<span style="color:#ef4444">${val.toFixed(2)}</span>`;
            if (isMin) return `<span style="color:#3b82f6">${val.toFixed(2)}</span>`;
            return val.toFixed(2);
          };
          const xVal = format(row.ax, idx === maxXRow, idx === minXRow);
          const yVal = format(row.ay, idx === maxYRow, idx === minYRow);
          const zVal = format(row.az, idx === maxZRow, idx === minZRow);
          html += `x:${xVal} y:${yVal} z:${zVal}<br>`;
        });
        $('output').innerHTML += html;

      } else if (value.startsWith('THR_OK')) {
        display("[æƒ…å ±] ã—ãã„å€¤è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸã€‚ãƒ‡ãƒã‚¤ã‚¹ã¯åˆ‡æ–­ã—ã¾ã™ã€‚");

        // UIã‚‚å¼·åˆ¶çš„ã«åˆ‡æ–­çŠ¶æ…‹ã«é·ç§»
        onDisconnected();
        
        // ãƒ‡ãƒã‚¤ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæ®‹ã£ã¦ã„ã‚Œã°ã“ã¡ã‚‰ã‹ã‚‰åˆ‡æ–­è¦æ±‚
        if (bleDevice && bleDevice.gatt.connected) {
          bleDevice.gatt.disconnect();
        }
        return;
      }else if (value.startsWith('ERROR')) {
        display('[ã‚¨ãƒ©ãƒ¼] ' + value);
      } else {
        console.warn('æœªçŸ¥ã®æ–‡å­—åˆ—ãƒ‡ãƒ¼ã‚¿:', value);
      }
    }

    $("sendSetting").onclick = async () => {
      const axis = $("axis").value;
      const threshold = parseFloat($("threshold").value);
      const count = parseInt($("count").value, 10);

      // ç§’ â†’ ms
      let durationSec = parseInt($("duration").value, 10);
      let machineSec  = parseInt($("machine_duration").value, 10);

      if (axis == "all" ) return display("[ã‚¨ãƒ©ãƒ¼] è»¸ã‚’ï¼‘ã¤é¸æŠã—ã¦ãã ã•ã„");
      if (count < 1 || count > 11) return display("[ã‚¨ãƒ©ãƒ¼] å›æ•°ã¯1ã€œ10å›ã§æŒ‡å®šã—ã¦ãã ã•ã„");
      if (durationSec < 1 || durationSec > 120) return display("[ã‚¨ãƒ©ãƒ¼] å‹•ä½œæ™‚é–“ã¯1ã€œ120ç§’ã§æŒ‡å®šã—ã¦ãã ã•ã„");
      if (machineSec  < 1 || machineSec  > 120) return display("[ã‚¨ãƒ©ãƒ¼] ã‚µã‚¤ã‚¯ãƒ«æ™‚é–“ã¯1ã€œ120ç§’ã§æŒ‡å®šã—ã¦ãã ã•ã„");

      const duration = durationSec * 1000;
      const machine_duration = machineSec * 1000;

      const command = `THR,${axis},${threshold},${count},${duration},${machine_duration}\n`;

      try {
        if (!txChar) {
          display("[ã‚¨ãƒ©ãƒ¼] å…ˆã«BLEæ¥ç¶šãŒå¿…è¦ã§ã™");
          return;
        }
        const encoder = new TextEncoder();
        await txChar.writeValue(encoder.encode(command));
        display(`[è¨­å®šé€ä¿¡] ${command.trim()}`);
      } catch (e) {
        display(`[ã‚¨ãƒ©ãƒ¼] è¨­å®šé€ä¿¡å¤±æ•—: ${e.message}`);
      }
    };

    $('threshold').addEventListener('input', e => {
      const val = parseFloat(e.target.value);
      if (!isNaN(val)) {
        thresholdY = val;
        $('thLabel').textContent = thresholdY.toFixed(2);
        chart?.update('none');
        updateAutoCount();
      }
    });

    function updateVisibleDatasets() {
      const selected = $('axis').value;
      if (!chart) return;
      chart.data.datasets.forEach((ds, idx) => {
        const axis = ['x', 'y', 'z'][idx];
        ds.hidden = (selected !== 'all' && selected !== axis);
      });
      chart.update('none');
    }
    $('axis').addEventListener('change', ()=>{ updateVisibleDatasets(); updateAutoCount(); });

    // === è‡ªå‹•å›æ•°ã‚«ã‚¦ãƒ³ãƒˆï¼ˆã—ãã„å€¤è¶…ãˆãƒ©ãƒ³æ•° â†’ å›æ•°ã«åæ˜ ï¼‰ ===
    function isOverThreshold(v, th){ return th >= 0 ? (v > th) : (v < th); }
    function countRunsOverThreshold(arr, th){ 
      let cnt=0, prev=false; 
      for(let i=0;i<arr.length;i++){ 
        const cur=isOverThreshold(arr[i], th); 
        if(cur && !prev) cnt++; prev=cur; 
      } return cnt; 
    }
    function updateAutoCount(){ 
      if(!chart) return;
      const sel=$('axis')?.value||'y'; 
      const idx= sel==='x'?0 : sel==='y'?1 : sel==='z'?2 : 1; 
      const dataArr=chart.data?.datasets?.[idx]?.data||[]; 
      const n=countRunsOverThreshold(dataArr, thresholdY); 
      const countEl=$('count'); 
      if(countEl && Number.isFinite(n)) countEl.value=n; 
    }

    function onDisconnected() {
      // æ¥ç¶šçŠ¶æ…‹ã®ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢
      rxChar = undefined;
      txChar = undefined;
      bleDevice = undefined;

      // UI ã®çŠ¶æ…‹ã‚’åˆæœŸåŒ–
      $('now').textContent   = 'æœªæ¥ç¶š';
      $('timer').textContent = 'åœæ­¢ä¸­';
      $('start').disabled    = true;
      $('stop').disabled     = true;
      $('reset').disabled    = true;
      $('connect').disabled    = false;

      // ã‚¿ã‚¤ãƒãƒ¼ã‚’æ­¢ã‚ã‚‹
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      startTime = null;

      // ãƒ­ã‚°ã«è¡¨ç¤º
      const el = $('output');
      el.textContent += '[æƒ…å ±] ãƒ‡ãƒã‚¤ã‚¹ãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ\n';
      el.scrollTop = el.scrollHeight;

      setMeasuring(false);
    }

    function resetChartData() {
      if (!chartInitialized) return;
      chart.data.labels.length = 0;
      chart.data.datasets.forEach(ds => ds.data.length = 0);
      chart.update('none');
    }

    $('reset').onclick = resetApp;

    // === ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®å®Ÿè£… ===
    function resetApp() {
      try {
        if (bleDevice?.gatt?.connected) bleDevice.gatt.disconnect();
      } catch {}

      // æ—¢å­˜ã®UIå¾©å¸°é–¢æ•°ï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰ã‚’å‘¼ã¶
      onDisconnected();

      // æ—¢å®šå€¤ã«æˆ»ã™
      thresholdY = 1.25;
      $('axis').value = 'all';
      $('threshold').value = thresholdY.toFixed(2);
      $('thLabel').textContent = thresholdY.toFixed(2);
      $('count').value = '10';
      $('duration').value = '1';
      $('machine_duration').value = '10';
      $('connect').disabled = false;

      // ãƒ­ã‚°ã¨å†…éƒ¨çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
      $('output').textContent = '';
      dataLog = [];
      ackQueue = [];
      isSendingAck = false;

      // ã‚°ãƒ©ãƒ•ã‚’åˆæœŸçŠ¶æ…‹ã¸
      resetChartData();
      $('rxCount').textContent = '0';
      $('timer').textContent = 'åœæ­¢ä¸­';
      $('now').textContent = 'æœªæ¥ç¶š';
      
    }

  </script>
</body>
</html>
